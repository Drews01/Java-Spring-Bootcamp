# Push Notification System Documentation

## Overview
The Java Spring Bootcamp application now includes a robust Push Notification system powered by **Firebase Cloud Messaging (FCM)**. This feature allows the backend to send real-time alerts to users regarding their **Loan Application** status changes, as well as enabling administrators to send manual notifications.

The implementation follows **SOLID principles**, specifically using the Interface Segregation Principle (ISP) and Open/Closed Principle (OCP) via a modular `NotificationChannel` architecture.

## Architecture

The notification system is composed of several key components:

### 1. Core Services
- **`FCMService`**: A low-level service wrapper around the Firebase Admin SDK. It handles the actual communication with Firebase servers to send messages.
- **`UserDeviceService`** (integrated into `FCMService`): Manages the lifecycle of FCM registration tokens, storing them in the `user_devices` table.

### 2. Business Logic (SOLID)
- **`NotificationChannel`**: A strategy interface defining how notifications can be sent (e.g., IN_APP, PUSH, EMAIL).
- **`PushNotificationChannel`**: An implementation of `NotificationChannel` that delegates to `FCMService`.
- **`LoanNotificationService`**: A dedicated service (following Single Responsibility Principle) that orchestrates notifications specifically for Loan Workflow events. It determines *what* message to send and *who* to send it to.

### 3. Data Model
- **`UserDevice` Entity**: Links a `User` to multiple FCM tokens (allowing a user to be logged in on multiple devices like Phone and Tablet).
  - `user_id`: The owner of the device.
  - `fcm_token`: The unique token generated by the client SDK (Firebase).
  - `device_name`: Metadata (e.g., "Samsung S21").
  - `platform`: `ANDROID`, `IOS`, or `WEB`.

## Configuration

### Prerequisites
1.  **Firebase Project**: You must have a Firebase project created in the Google Cloud Console.
2.  **Service Account**: Generate a private key JSON file from **Firebase Console > Project Settings > Service Accounts**.
3.  **File Placement**: Place the downloaded JSON file in `src/main/resources/firebase-service-account.json`.

### Application Properties
The configuration is loaded via `FirebaseConfig.java`. Ensure your `application.yml` contains:

```yaml
firebase:
  service-account-path: firebase-service-account.json
```

## API Endpoints

### 1. Device Registration (Mobile/Frontend)
Clients **must** register their FCM token after logging in to receive notifications.

**Endpoint**: `POST /api/fcm/register`
**Auth**: Bearer Token (User)

**Parameters**:
- `fcmToken` (required): The string token from Firebase Client SDK.
- `deviceName` (optional): e.g., "Pixel 6".
- `platform` (optional): `ANDROID`, `IOS`, or `WEB`.

**Example**:
```bash
curl -X POST "http://localhost:8080/api/fcm/register?fcmToken=YOUR_TOKEN&platform=ANDROID" \
     -H "Authorization: Bearer <your_jwt>"
```

### 2. Device Unregistration
Call this when the user logs out to stop sending notifications to that device.

**Endpoint**: `DELETE /api/fcm/unregister`
**Auth**: Bearer Token (User)

**Parameters**:
- `fcmToken` (required)

### 3. Send Manual Notification (Admin Only)
Allows admins to broadcast a message to a specific user.

**Endpoint**: `POST /api/fcm/send`
**Auth**: Bearer Token (Admin)

**Body**:
```json
{
  "userId": 101,
  "title": "Payment Reminder",
  "body": "Your payment is due tomorrow.",
  "data": {
    "screen": "payment_detail",
    "loanId": "55"
  }
}
```

## Automated Loan Workflow Notifications

The system automatically triggers push notifications for the following status transitions. Messages are localized in **Indonesian**.

| Transition | From Status | To Status | Notification Title | Notification Body |
|:---|:---|:---|:---|:---|
| **Submission** | `SUBMITTED` | `IN_REVIEW` | Sedang Di-review Marketing | Pengajuan pinjaman Anda sedang di-review oleh tim Marketing |
| **Review** | `IN_REVIEW` | `WAITING_APPROVAL` | Sedang Di-review Manager | Pinjaman Anda sedang ditinjau oleh Branch Manager |
| **Approval** | `WAITING_APPROVAL` | `APPROVED` | Pinjaman Disetujui | Selamat! Pinjaman Anda telah disetujui, menunggu pencairan |
| **Rejection** | `WAITING_APPROVAL` | `REJECTED` | Pinjaman Ditolak | Maaf, pengajuan pinjaman Anda ditolak |
| **Disbursement** | `APPROVED` | `DISBURSED` | Pinjaman Dicairkan | Dana pinjaman Anda telah dicairkan |

### Staff Notifications
Staff members also receive notifications when actions are required:
- **Branch Managers** receive a push notification when a loan enters `WAITING_APPROVAL`.
- **Back Office** staff receive a push notification when a loan is `APPROVED` and needs disbursement.

## Testing Integration

To verify the integration without a real mobile app:

1.  **Get a Test Token**: You can use a tool like "Push Notification Test" app or a simple web script to generate a valid FCM token for the project.
2.  **Register**: Use the `/api/fcm/register` endpoint to link that token to your test user.
3.  **Trigger Event**:
    - **Option A**: Use the `/api/fcm/test` endpoint to send a self-test.
    - **Option B**: Process a loan application through the workflow (Submit -> Action) and watch the notifications arrive on the device.

## Troubleshooting

- **`IOError: firebase-service-account.json not found`**: Ensure the file exists in `target/classes/` after build. content.
- **`403 Forbidden`**: Ensure the user has the correct role (USER for register, ADMIN for manual send).
- **Notifications not arriving**:
    - Check server logs for `FCMService` errors.
    - Verify the `fcmToken` is valid and not expired.
    - Check if the Application ID in `firebase-service-account.json` matches the client app.
